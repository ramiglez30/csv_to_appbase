<!DOCTYPE html>
<html>

<head>
    <title>Probando CSV-Jquery</title>


    <link href="css/bootstrap.css" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <h1>Loading CSV</h1>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2>Import file:</h2>
            </div>
            <div class="panel-body">

                <div>
                    <input id="csv_file_input" type="file" accept=".csv" /><br />

                    <label>File content:</label>
                    <textarea id="file_content" class="form-control" style="min-height:100px"></textarea>

                    <br />
                    <div>
                        <b> <input id="first_line_header_check" type="checkbox" /> <span>Is first row column headings?</span></b>
                    </div>
                    <br />

                </div>


                <div class="panel panel-default">
                    <div class="panel-heading form-group">
                        <h3>Mapping</h3>
                        <label>Select FORM to send data:</label>
                        <select class="form-control form-control" id="form_names">
                           <option id="op_0_select">Select...</option>
                        </select>
                    </div>
                    <div class="panel-body">
                        <table id="table_mapping" class="table">
                            <thead>
                                <tr>
                                    <th style="width:70px">index</th>
                                    <th>CSV Columns</th>
                                    <th>Data Sample</th>
                                    <th>FORM Columns</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>

                        </table>

                    </div>

                </div>
            </div>

        </div>
    </div>
    <script src="js/jquery-1.12.4.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/csv_loader.js"></script>
    <script src="js/papaparse.min.js"></script>
    <script src="js/appBaseService.js"></script>
    <script>
        $(document).ready(function() {
            //carga fichero y contenido en el textarea
            $('#csv_file_input').bind('change', function(event) {
                var input = event.target;

                var reader = new FileReader();
                reader.onload = function() {
                    var text = reader.result.split(' ').filter(n => n).join(' ');
                    var content = document.getElementById('file_content');
                    content.value = text;
                }
                reader.readAsText(input.files[0]);
            });
            //busca los datos desde el appbase
            $.appBaseService.getForms(function(result) {
                var keys = Object.keys(result);
                keys.forEach(key => {
                    var drop_forms = document.getElementById('form_names');
                    var option = document.createElement('option');
                    option.text = key;
                    drop_forms.add(option);
                });
            });
        });
    </script>
    <script>
        $(document).ready(function() {
            //datos parseados a JSON
            var json_array = null;

            //event handler para cuando el usuario marca la primera fila como cabecera
            $('input[type=checkbox]').on('change', function() {
                parseCSVtoJSON();
            });

            //event handler para el select form
            $('select#form_names').on('change', function() {
                var formObject = null;
                $.appBaseService.getForms((result) => {
                    formObject = result[this.options[this.selectedIndex].value]
                });
                seedSourceColumns(formObject.properties);
            });

            //event handler para cuando el usuario edita el texto
            $("#file_content").on("input", function(event) {
                parseCSVtoJSON();
            });

            //function parser del texto CSV a un objeto JSON
            var parseCSVtoJSON = function() {
                json_array = Papa.parse($('#file_content').val(), {
                    dynamicTyping: true,
                    header: false
                });
            };

            //llena la tabla del mapping
            var seedSourceColumns = function(targetColumns) {
                if (json_array == null) {
                    parseCSVtoJSON();
                }
                var row0 = json_array.data[0];
                var row1 = json_array.data[1];

                var table = document.getElementById('table_mapping');
                while (table.rows.length > 1) {
                    table.deleteRow(table.rows.length - 1);
                }
                for (i = 0; i < row0.length; i++) {
                    var row = table.insertRow(table.rows.length);
                    var columnIndex = row.insertCell(0);
                    columnIndex.innerHTML = i.toString();
                    var columnName = row.insertCell(1);
                    var is_first_line_header = document.getElementById('first_line_header_check').checked
                    if (is_first_line_header) {
                        columnName.innerHTML = row0[i];
                    } else {
                        columnName.innerHTML = 'Column' + i.toString();
                    }

                    var columnData = row.insertCell(2);
                    columnData.innerHTML = row1[i];
                    var columnMapping = row.insertCell(3);

                    var select = document.createElement('select');
                    select.setAttribute('class', 'form-control');
                    select.setAttribute('id', 'select_' + i.toString());
                    //crear option select

                    for (j = 0; j < targetColumns.length; j++) {
                        var prop = targetColumns[j];
                        var option = document.createElement('option');
                        option.text = prop.name;
                        select.appendChild(option);
                    }

                    columnMapping.appendChild(select);

                }
            };
        });
    </script>


    <script src="js/mocks.js"></script>

    <script src="js/test/appBaseServiceTest.js"></script>
</body>

</html>