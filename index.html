<!DOCTYPE html>
<html>

<head>
    <title>Probando CSV-Jquery</title>


    <link href="css/bootstrap.css" rel="stylesheet" />

    <link href="css/csv_importer.css" rel="stylesheet" />
    <script>
        Function.prototype.applyAsync = function(params, cb) {
            var function_context = this;
            setTimeout(function() {
                var val = function_context.apply(this, params);
                if (cb) cb(val);
            }, 0);
        };
    </script>
</head>

<body>
    <div class="container">
        <h1>Loading CSV</h1>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2>Import file:</h2>
            </div>
            <div class="panel-body">

                <div>
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                            <input id="csv_file_input" type="file" accept=".csv" />
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 text-right">
                            <a id="see_source_btn" class="btn btn-primary" role="button" data-toggle="collapse" href="#div_file_content" aria-expanded="false" aria-controls="div_file_content">See source file content &nbsp;<span class=" glyphicon glyphicon-chevron-down"></span></a>
                        </div>
                    </div>
                    <br />

                    <div id="div_file_content" class="collapse">
                        <textarea id="file_content" class="form-control" style="min-height:100px"></textarea>
                    </div>

                    <br>

                </div>


                <div class="panel panel-default">
                    <div class="panel-heading form-group">
                        <h3>Mapping</h3>
                        <label>Select FORM to send data:</label>
                        <select class="form-control form-control" style='max-width:500px;' id="form_names">
                           <option id="0">Select...</option>
                        </select>
                        <br>
                        <input id="first_row_checker" type="checkbox" text="" /> <span> Is first row columns names?</span>
                    </div>
                    <div id="table_container" class="panel-body">
                        <table id="table_mapping" class="table">
                            <thead>

                            </thead>
                            <tbody>

                            </tbody>

                        </table>

                    </div>



                </div>
            </div>
            <div class="panel-footer">
                <label>Write a name for this mapping.</label><br>
                <input id="mapNameText" type="text" class="form-control" style='max-width:500px;' required/><br>
                <button id="send_data_btn" class="btn btn-primary">Send Data to App Base</button>
            </div>

        </div>
    </div>


    <div class="modal fade" id="modal-progress">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Sending data to AppBase</h4>
                </div>
                <div class="modal-body">
                    <progress id="sendingProgress" class="form-control"></progress>
                    <div id="saving-trace">
                        <div style="margin:10px ">
                            <span id="currentItem"></span>
                        </div>
                        <button id="btn-expand" class="btn btn-default btn-circle" type="button" data-toggle="collapse" data-target="#stackTraceContiner" aria-expanded="false" aria-controls="stackTraceContiner">
                        <span class="glyphicon glyphicon-chevron-down"></span>
                        </button>
                        <div class="collapse" id="stackTraceContiner">
                            <div class="well">
                                <ul id="stackTrace">

                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="js/jquery-1.12.4.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/csv_loader.js"></script>
    <script src="js/papaparse.min.js"></script>
    <script src="js/mocks.js"></script>
    <script src="js/appBaseService.js"></script>

    <script>
        $('#see_source_btn').on('click', function() {
            if (!$('#div_file_content').hasClass('in')) {
                $(this).children('span').removeClass('glyphicon-chevron-down');
                $(this).children('span').addClass('glyphicon-chevron-up');
            } else {
                $(this).children('span').removeClass('glyphicon-chevron-up');
                $(this).children('span').addClass('glyphicon-chevron-down');
            }
        });

        $('#btn-expand').on('click', function() {
            if (!$('#stackTraceContiner').hasClass('in')) {
                $(this).children('span').removeClass('glyphicon-chevron-down');
                $(this).children('span').addClass('glyphicon-chevron-up');
            } else {
                $(this).children('span').removeClass('glyphicon-chevron-up');
                $(this).children('span').addClass('glyphicon-chevron-down');
            }
        });

        //prepara el objeto mapping para enviar 
        var prepData = function() {
            //opening modal
            $('#modal-progress').modal('show');
            $('#currentItem').html('');
            $('#stackTrace').html('');

            $.mappingObj.formName = $('select#form_names').children('option:selected').val();
            $.mappingObj.isFirstColumnHeading = $('#first_row_checker').is(':checked');
            $.mappingObj.sourceName = $('#mapNameText').val();
            var selectedOptions = $('select.form_columns').children('option:selected');
            $.mappingObj.mappingProperties = [];
            if (selectedOptions.length > 0) {
                //pushing selected columns
                selectedOptions.each(function(item) {
                    var fileColumn = {
                        colStart: 0,
                        colEnd: 0,
                        index: 0,
                        isIgnored: false
                    };
                    var formColumn = {
                        name: '',
                        type: '',
                        order: 0,
                        isReference: false,
                        reference: {
                            formName: '',
                            fieldName: ''
                        }
                    };
                    var map = {
                        fileColumn: fileColumn,
                        formColumn: formColumn
                    };
                    var counting = 0;

                    map.fileColumn.index = item;
                    if ($(this).val() != 'ignore') {
                        map.formColumn.name = $(this).attr('data-name');
                        map.formColumn.type = $(this).attr('data-type');
                        map.formColumn.order = $(this).attr('data-order');
                        map.formColumn.isReference = $(this).attr('data-isreference') == 'true';
                        if (map.formColumn.isReference) {
                            map.formColumn.reference.formName = $(this).attr('data-formreferenced');
                            map.formColumn.reference.fieldName = $(this).attr('data-datareferenced');
                        }
                        $.mappingObj.mappingProperties.push(map);
                        counting++;
                    }


                });

                //pushing missing data-columns
                var mapped = $.mappingObj.mappingProperties.map(function(item) {
                    item.formColumn.name
                });
                var nonMapProperties = $.selectedForm.properties.filter(function(item) {
                    return !mapped.includes(item.name);
                });

                $(nonMapProperties).each(function(i) {
                    var fileColumn = {
                        colStart: 0,
                        colEnd: 0,
                        index: 0,
                        isIgnored: true
                    };
                    var formColumn = {
                        name: nonMapProperties[i].name,
                        type: nonMapProperties[i].type,
                        order: nonMapProperties[i].order,
                        isReference: nonMapProperties[i].isReference == "true",
                        reference: {
                            formName: '',
                            fieldName: ''
                        }
                    };
                    if (nonMapProperties[i].isReference == "true") {
                        formColumn.reference.formName = nonMapProperties[i].formReferenced;
                        formColumn.reference.fieldName = nonMapProperties[i].dataReferenced;
                    }
                    var map = {
                        fileColumn: fileColumn,
                        formColumn: formColumn
                    };
                    $.mappingObj.mappingProperties.push(map);

                });



                var total = $.json_array.data.length + 1;
                var progressValue = 0;
                $('#sendingProgress').attr('max', total);
                $('#sendingProgress').attr('value', progressValue);

                /**Aqui tener en cuenta que no se puede guardar dos mapping con el mismo identificador
                 * contemplar este caso y notificar el usuario
                 */
                var current = 1;
                $('#currentItem').html(current + ' of ' + total);

                $.appBaseService.saveMapping($.mappingObj, function(endCallbackData) {
                    if (endCallbackData != undefined && endCallbackData != null) {
                        if (endCallbackData.code == 300) {
                            alert(endCallbackData.message);
                            var errorSpan = '<span style="color:red;">Error: </span>'
                            $('#currentItem').html(errorSpan + endCallbackData.message);
                            return;
                        } else {

                            if (endCallbackData.stackTrace != undefined) {
                                for (var i in endCallbackData.stackTrace) {
                                    var litem = '<li>' + endCallbackData.stackTrace[i] + '</li>'
                                    $('#stackTrace').append(litem);
                                }
                            }

                            $('#sendingProgress').attr('value', progressValue++);
                            $.appBaseService.saveFormData($.mappingObj, $.json_array.data, function(data) {

                                $('#sendingProgress').attr('value', progressValue++);
                                current++;
                                $('#currentItem').html(current + ' of ' + total);
                                var litem = '<li>' + data.message + '</li>'
                                $('#stackTrace').append(litem);
                            }, function() {
                                //alert('listo!');
                            });
                        }
                    }
                    /**  Revisar en el appBaseService que la funcion endCallback siempre devuelva un objeto
                                        con un codigo y un mesaje para que pueda ser empleado como forma de validacion en el cliente  */

                    /** Aqui hay que validar el codigo de retorno del callback y mostrar el mensaje adecuadamente en la pantalla
                     * Revisar que funcione bien el progressbar con respecto a lo que esta sucediendo en el service
                     */

                });

            } else {
                alert('Ups, seems like you haven\'t choosed any Form to map');
                return;
            }


        }

        $('#send_data_btn').on('click', function() {
            prepData();
        });
    </script>

    <!--script src="js/mocks.js"></script-->

    <!--script src="js/test/appBaseServiceTest.js"></script-->
    <script src="js/csv_importer.js"></script>
</body>

</html>